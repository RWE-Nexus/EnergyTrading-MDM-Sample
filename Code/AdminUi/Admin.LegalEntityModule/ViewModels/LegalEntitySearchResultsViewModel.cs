// This code was generated by a tool: ViewModelTemplates\EntitySearchResultsViewModelTemplate.tt
namespace Admin.LegalEntityModule.ViewModels
{
    using System;
    using System.Collections.Generic;
    using System.Collections.ObjectModel;
    using System.Linq;
    using System.Windows;
    using System.Windows.Input;
    using System.Windows.Media;

    using Admin.LegalEntityModule.Uris;

    using Common.Events;
    using Common.Extensions;
    using Common.Services;

    using EnergyTrading.Contracts.Search;
    using EnergyTrading.Mdm.Client.Services;
    using EnergyTrading.MDM.Contracts.Sample;

    using Microsoft.Practices.Prism;
    using Microsoft.Practices.Prism.Events;
    using Microsoft.Practices.Prism.ViewModel;

    public class LegalEntitySearchResultsViewModel : NotificationObject, IActiveAware
    {
        private readonly IMdmService entityService;

        private readonly IEventAggregator eventAggregator;

        private readonly INavigationService navigationService;

        private bool isActive;

        private ObservableCollection<LegalEntityViewModel> legalentitys;

        private Search search;

        private LegalEntityViewModel selectedLegalEntity;

        public LegalEntitySearchResultsViewModel(
            INavigationService navigationService, 
            IEventAggregator eventAggregator, 
            IMdmService entityService)
        {
            this.navigationService = navigationService;
            this.eventAggregator = eventAggregator;
            this.entityService = entityService;
            this.IsActiveChanged += this.OnIsActiveChanged;
        }

        public event EventHandler IsActiveChanged;

        public bool IsActive
        {
            get
            {
                return this.isActive;
            }

            set
            {
                if (this.isActive != value)
                {
                    this.isActive = value;
                }

                this.IsActiveChanged(this, EventArgs.Empty);
            }
        }

        public ObservableCollection<LegalEntityViewModel> LegalEntitys
        {
            get
            {
                return this.legalentitys;
            }

            set
            {
                this.legalentitys = value;
                this.RaisePropertyChanged(() => this.LegalEntitys);
                if (LegalEntitys != null && LegalEntitys.Count > 0 && SelectedLegalEntity == null)
                {
                    SelectedLegalEntity = LegalEntitys[0];
                }
            }
        }

        public LegalEntityViewModel SelectedLegalEntity
        {
            get
            {
                return this.selectedLegalEntity;
            }

            set
            {
                this.selectedLegalEntity = value;
                this.RaisePropertyChanged(() => this.SelectedLegalEntity);
            }
        }

        public void NavigateToDetail(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter && this.SelectedLegalEntity != null)
            {
                this.navigationService.NavigateMain(
                    new LegalEntityEditUri(this.SelectedLegalEntity.Id.Value, this.search.AsOf.Value));
            }
        }

        public void NavigateToDetailDoubleClick(object sender, MouseButtonEventArgs e)
        {
            DependencyObject src = VisualTreeHelper.GetParent((DependencyObject)e.OriginalSource);

            if (src.GetType() == typeof(System.Windows.Controls.ContentPresenter))
            {
                if (this.SelectedLegalEntity != null)
                {
                    this.navigationService.NavigateMain(
                        new LegalEntityEditUri(this.SelectedLegalEntity.Id.Value, this.search.AsOf.Value));
                }
            }
        }

        public void Sorting()
        {
            this.SelectedLegalEntity = null;
        }

        private void OnIsActiveChanged(object sender, EventArgs eventArgs)
        {
            if (this.isActive)
            {
                this.eventAggregator.Subscribe<SearchRequestEvent>(this.SearchRequest);
                return;
            }

            this.eventAggregator.Unsubscribe<SearchRequestEvent>(this.SearchRequest);
        }

        private void SearchRequest(SearchRequestEvent searchRequestEvent)
        {
            searchRequestEvent.Search.SearchOptions.OrderBy = "Name";

            this.entityService.ExecuteAsyncSearch<LegalEntity>(
                this.search = searchRequestEvent.Search, 
                response =>
                    {
                        IList<LegalEntity> searchResults = response;
                        this.LegalEntitys =
                            new ObservableCollection<LegalEntityViewModel>(
                                searchResults.Select(
                                    x =>
                                    new LegalEntityViewModel(
                                        new EntityWithETag<LegalEntity>(x, null), 
                                        this.eventAggregator)).OrderBy(y => y.Name));
                    }, 
                this.eventAggregator);
        }
    }
}